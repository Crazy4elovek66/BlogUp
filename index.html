// В начале скрипта добавляем:
const backendUrl = 'https://blogup.up.railway.app'; // Замените на ваш URL

// Функция загрузки данных пользователя
async function loadUserData() {
    try {
        const initData = tg.initData;
        const user = tg.initDataUnsafe.user;
        
        if (!user) {
            throw new Error('User not authorized');
        }
        
        const response = await fetch(`${backendUrl}/api/user_data?user_id=${user.id}`, {
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load user data');
        }
        
        const data = await response.json();
        return data;
        
    } catch (error) {
        console.error('Error loading user data:', error);
        // Возвращаем данные по умолчанию при ошибке
        return {
            views: 0,
            subscribers: 0,
            click_power: 1,
            level: 'Новичок'
        };
    }
}

// Функция сохранения данных пользователя
async function saveUserData(data) {
    try {
        const user = tg.initDataUnsafe.user;
        
        if (!user) {
            throw new Error('User not authorized');
        }
        
        const response = await fetch(`${backendUrl}/api/save_data`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: user.id,
                ...data
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save user data');
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('Error saving user data:', error);
    }
}

// Обновляем инициализацию игры
async function initGame() {
    const userData = await loadUserData();
    
    // Устанавливаем начальные значения
    views = userData.views || 0;
    subscribers = userData.subscribers || 0;
    clickPower = userData.click_power || 1;
    
    // Обновляем интерфейс
    viewsElement.textContent = formatNumber(views);
    subscribersElement.textContent = formatNumber(subscribers);
    
    // Устанавливаем активный уровень
    document.querySelectorAll('.level').forEach(levelEl => {
        levelEl.classList.remove('active');
        if (levelEl.textContent === userData.level) {
            levelEl.classList.add('active');
        }
    });
    
    // Сохраняем данные при закрытии
    tg.onEvent('viewportChanged', async () => {
        if (tg.isClosing) {
            await saveUserData({
                views: views,
                subscribers: subscribers,
                click_power: clickPower,
                level: document.querySelector('.level.active').textContent
            });
        }
    });
    
    // Периодическое автосохранение (каждые 30 секунд)
    setInterval(async () => {
        await saveUserData({
            views: views,
            subscribers: subscribers,
            click_power: clickPower,
            level: document.querySelector('.level.active').textContent
        });
    }, 30000);
}

// Заменяем вызов tg.expand() на:
tg.ready();
initGame();
